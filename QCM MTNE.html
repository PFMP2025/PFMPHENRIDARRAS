<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test d'Orientation - Bac Pro</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 2rem; color: #333; }
    h1, h2 { text-align: center; }
    form { max-width: 800px; margin: 2rem auto; background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .question { margin-bottom: 1.5rem; }
    label { display: block; margin: 0.4rem 0; }
    button { display: block; margin: 2rem auto; padding: 0.8rem 2rem; background: #004080; color: white; border: none; border-radius: 5px; font-size: 1rem; cursor: pointer; }
    #resultat { max-width: 600px; margin: 2rem auto; background: #e0ffe0; padding: 1.5rem; border-radius: 10px; color: #004d00; font-weight: bold; display: none; }
    .bouton-retour {
      position: fixed;
      top: 10px;
      left: 10px;
      padding: 8px 16px;
      font-size: 16px;
      border-radius: 5px;
      background-color: #007BFF;
      color: white;
      border: none;
      cursor: pointer;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <button class="bouton-retour" onclick="history.back()">‚Üê Retour</button>
  <h1>Test d'Orientation : Quelle fili√®re et quel m√©tier sont faits pour toi ?</h1>
  <form id="qcmForm"></form>
  <div id="resultat"></div>
  <canvas id="graphiqueFiliere" style="max-width: 500px; margin: 2rem auto; display: none;"></canvas>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const metiers = {
      ciel_devweb: { nom: "D√©veloppeur web", filiere: "CIEL" },
      ciel_embarque: { nom: "D√©veloppeur embarqu√©", filiere: "CIEL" },
      ciel_cyber: { nom: "Technicien cybers√©curit√©", filiere: "CIEL" },
      ciel_electronique: { nom: "Technicien √©lectronique", filiere: "CIEL" },
      melec_electricien: { nom: "√âlectricien du b√¢timent", filiere: "MELEC" },
      melec_maintenance: { nom: "Technicien de maintenance", filiere: "MELEC" }
    };

    const questions = [
      { q: "1. Tu es le plus satisfait quand tu :", options: [
        { t: "R√©sous un probl√®me complexe en trouvant une solution logique", m: ["ciel_cyber", "ciel_devweb", "melec_maintenance"] },
        { t: "Vois le r√©sultat concret de ce que tu as fabriqu√© ou install√©", m: ["melec_electricien"] }
      ]},
      { q: "2. Tu te sens plus √† l‚Äôaise quand :", options: [
        { t: "Tu peux imaginer ou cr√©er quelque chose de nouveau", m: ["ciel_devweb", "ciel_embarque"] },
        { t: "Tu respectes un plan, une norme ou une consigne", m: ["melec_electricien"] },
        { t: "Tu interviens en autonomie sur un syst√®me concret", m: ["melec_maintenance"] }
      ]},
      { q: "3. Face √† une difficult√© technique, tu pr√©f√®res :", options: [
        { t: "Analyser calmement la situation pour trouver une cause logique", m: ["ciel_cyber", "melec_maintenance"] },
        { t: "Essayer directement des solutions concr√®tes", m: ["melec_electricien"] }
      ]},
      { q: "4. Tu aimes particuli√®rement :", options: [
        { t: "Programmer ou comprendre des circuits √©lectroniques", m: ["ciel_embarque", "ciel_electronique"] },
        { t: "Travailler sur des c√¢bles, moteurs ou installations", m: ["melec_electricien", "melec_maintenance"] }
      ]},
      { q: "5. Ton environnement id√©al serait :", options: [
        { t: "Un endroit calme avec ordinateurs et logiciels", m: ["ciel_devweb", "ciel_cyber"] },
        { t: "Un atelier ou un chantier avec des outils techniques", m: ["melec_electricien"] }
      ]}
    ];

    const form = document.getElementById("qcmForm");
    questions.forEach((q, i) => {
      const block = document.createElement("div");
      block.className = "question";
      const title = document.createElement("h2");
      title.textContent = q.q;
      block.appendChild(title);
      q.options.forEach((opt) => {
        const label = document.createElement("label");
        label.innerHTML = `<input type=\"radio\" name=\"q${i}\" value=\"${opt.m.join(',')}\"> ${opt.t}`;
        block.appendChild(label);
      });
      form.appendChild(block);
    });

    const submit = document.createElement("button");
    submit.type = "submit";
    submit.textContent = "Voir mes r√©sultats";
    form.appendChild(submit);

    form.addEventListener("submit", function(e) {
      e.preventDefault();
      const scores = {}, filieres = {};
      for (let key in metiers) {
        scores[key] = 0;
        filieres[metiers[key].filiere] = 0;
      }

      questions.forEach((_, i) => {
        const answer = document.querySelector(`input[name="q${i}"]:checked`);
        if (answer) {
          answer.value.split(',').forEach(m => {
            scores[m]++;
            filieres[metiers[m].filiere]++;
          });
        }
      });

      const totalMetierPoints = Object.values(scores).reduce((a, b) => a + b, 0);
      const topMetiers = Object.entries(scores)
        .map(([key, val]) => ({ nom: metiers[key].nom, score: Math.round((val / totalMetierPoints) * 100) }))
        .filter(r => r.score > 0)
        .sort((a, b) => b.score - a.score)
        .slice(0, 3);

      const topFiliere = Object.entries(filieres).sort((a, b) => b[1] - a[1])[0][0];

      const div = document.getElementById("resultat");
      div.innerHTML = `
        <h2>üîé R√©sultats</h2>
        <p><strong>Fili√®re dominante : ${topFiliere}</strong></p>
        <ul>
          ${topMetiers.map(r => `<li>${r.nom} : ${r.score} %</li>`).join('')}
        </ul>
        <div id="suggestionsStages"><em>Chargement des suggestions de stage...</em></div>
        <div style="margin-top:1.5rem; text-align:center;">
          <button onclick="location.reload()" style="margin:0.5rem;padding:0.5rem 1rem;background:#ccc;border:none;border-radius:4px;">üîÅ Recommencer</button>
        </div>
      `;

      const canvas = document.getElementById("graphiqueFiliere");
      canvas.style.display = "block";

      const ctx = canvas.getContext("2d");
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['CIEL', 'MELEC'],
          datasets: [{
            label: 'R√©partition par fili√®re',
            data: [
              filieres.CIEL || 0,
              filieres.MELEC || 0
            ],
            backgroundColor: [
              '#87CEEB',
              '#32CD32'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            title: {
              display: true,
              text: 'R√©partition de tes r√©ponses par fili√®re'
            }
          }
        }
      });

      // R√©cup√©ration dynamique des lieux depuis fiches.html
      fetch('fiches.html')
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const listItems = doc.querySelectorAll(`#${topFiliere.toLowerCase()} ul li`);
          const lieux = Array.from(listItems).map(li => li.textContent.trim());
          const suggestions = lieux.sort(() => 0.5 - Math.random()).slice(0, 5);

          const suggestionsHtml = `
            <h3>üè≠ Suggestions de lieux de stage (${topFiliere}) :</h3>
            <ul>
              ${suggestions.map(lieu => `<li>${lieu}</li>`).join('')}
            </ul>
          `;
          document.getElementById("suggestionsStages").innerHTML = suggestionsHtml;
        })
        .catch(err => {
          console.error('Erreur chargement lieux :', err);
          document.getElementById("suggestionsStages").innerHTML = `<p style="color:red;">Impossible de charger les suggestions depuis fiches.html</p>`;
        });

      div.style.display = "block";
      form.style.display = "none";
      div.scrollIntoView({ behavior: 'smooth' });
    });
  </script>
</body>
</html>
